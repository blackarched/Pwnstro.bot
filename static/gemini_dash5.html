<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pwnagotchi C&C | Live Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        :root { font-family: "VT323", monospace; --background-color: #000; --neon-purple: #b347ff; --neon-pink: #ff47b3; --neon-green: #47ff47; --neon-yellow: #ffff47; --neon-cyan: #47ffff; scrollbar-color: var(--neon-green) var(--background-color); font-size: clamp(14px, 2vw, 18px); }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: var(--background-color); color: var(--neon-green); overflow: hidden; }
        .retro-container { width: 95vw; height: 95vh; display: grid; grid-template-rows: auto 1fr auto; overflow: hidden; padding: 0.5rem; border: 2px solid var(--neon-cyan); text-shadow: 0 0 0.5rem var(--neon-green); box-shadow: inset 0 0 2rem var(--neon-cyan); background-color: rgba(0, 0, 0, 0.75); }
        header { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid var(--neon-purple); }
        .logo { font-size: 1.5rem; text-shadow: 0 0 1rem var(--neon-pink); color: var(--neon-pink); }
        nav ul { display: flex; gap: 1rem; list-style: none; }
        nav a { color: var(--neon-yellow); text-decoration: none; padding: 0.5rem 1rem; border: 1px solid transparent; transition: all 0.3s ease-in-out; cursor: pointer; }
        nav a:hover, nav a.active { background-color: var(--neon-yellow); color: var(--background-color); border-color: var(--neon-yellow); }
        main { overflow: hidden; padding: 1rem; }
        section { display: none; height: 100%; overflow: auto; }
        section.active { display: grid; }
        .grid-container, .grid-container-full { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; height: 100%; }
        .module { border: 1px solid var(--neon-purple); padding: 1rem; background-color: rgba(179, 71, 255, 0.05); }
        .module-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--neon-purple); }
        .module-title { font-size: 1.2rem; color: var(--neon-purple); }
        .module-content { height: calc(100% - 45px); overflow-y: auto; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
        .face { font-size: 4rem; height: 70px; line-height: 70px; text-align: center; }
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 0.5rem; text-align: left; border-bottom: 1px solid var(--neon-purple); }
        .table th { color: var(--neon-yellow); }
        .button { background: none; border: 1px solid var(--neon-pink); color: var(--neon-pink); padding: 0.25rem 0.5rem; cursor: pointer; font-family: inherit; font-size: 0.9rem; }
        .button:hover { background-color: var(--neon-pink); color: var(--background-color); }
        .button.warning { border-color: var(--neon-yellow); color: var(--neon-yellow); }
        .button.warning:hover { background-color: var(--neon-yellow); }
        .button.danger { border-color: #ff0000; color: #ff0000; }
        .button.danger:hover { background-color: #ff0000; }
        footer { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 1rem; border-top: 1px solid var(--neon-purple); }
        .footer-controls { display: flex; gap: 1rem; }
        .scrollbar-custom { scrollbar-width: thin; scrollbar-color: var(--neon-purple) var(--background-color); }
        .scrollbar-custom::-webkit-scrollbar { width: 8px; }
        .scrollbar-custom::-webkit-scrollbar-track { background: var(--background-color); }
        .scrollbar-custom::-webkit-scrollbar-thumb { background-color: var(--neon-purple); }
        .toggle-switch { position: relative; width: 40px; height: 20px; border: 1px solid var(--neon-green); background: transparent; cursor: pointer; }
        .toggle-switch.active { background-color: var(--neon-green); }
        .toggle-switch::before { content: ''; position: absolute; width: 16px; height: 16px; top: 1px; left: 1px; background-color: var(--neon-green); transition: transform 0.3s; }
        .toggle-switch.active::before { transform: translateX(20px); background-color: var(--background-color); }
        #config-editor { width: 100%; height: calc(100% - 40px); background: #0a0a0a; color: var(--neon-green); border: 1px solid var(--neon-purple); padding: 0.5rem; font-family: inherit; }
    </style>
</head>
<body>
<div class="retro-container">
    <header>
        <div class="logo">üêæ PWNAGOTCHI C&C</div>
        <nav role="navigation">
            <ul>
                <li><a href="#dashboard" class="nav-link active">DASHBOARD</a></li>
                <li><a href="#handshakes" class="nav-link">HANDSHAKES</a></li>
                <li><a href="#peers" class="nav-link">PEERS</a></li>
                <li><a href="#plugins" class="nav-link">PLUGINS</a></li>
                <li><a href="#config" class="nav-link">CONFIG</a></li>
            </ul>
        </nav>
    </header>
    <main>
        <section id="dashboard" class="active grid-container">
            <div class="module">
                <div class="module-header"><h3 class="module-title">STATUS</h3></div>
                <div class="face" id="mood-face">(‚åê‚ñ†_‚ñ†)</div>
                <div id="mood-text" style="text-align:center; color: var(--neon-pink);">LOADING...</div>
            </div>
            <div class="module">
                <div class="module-header"><h3 class="module-title">SYSTEM</h3></div>
                <div class="stat-row"><span>CPU:</span><span id="cpu-usage">--%</span></div>
                <div class="stat-row"><span>Mem:</span><span id="memory-usage">--</span></div>
                <div class="stat-row"><span>Temp:</span><span id="temperature">--¬∞C</span></div>
                <div class="stat-row"><span>Uptime:</span><span id="uptime">--</span></div>
            </div>
            <div class="module">
                <div class="module-header"><h3 class="module-title">SESSION</h3></div>
                <div class="stat-row"><span>Epoch:</span><span id="epoch">--</span></div>
                <div class="stat-row"><span>APs:</span><span id="networks-count">0</span></div>
                <div class="stat-row"><span>Handshakes:</span><span id="handshake-count">0</span></div>
                <div class="stat-row"><span>Peers:</span><span id="peer-count">0</span></div>
            </div>
            <div class="module">
                <div class="module-header"><h3 class="module-title">AI BRAIN</h3></div>
                <div class="stat-row"><span>AI Mode:</span><span id="ai-mode">--</span></div>
                <div class="stat-row"><span>Learning Rate:</span><span id="ai-lr">--</span></div>
                <div class="stat-row"><span>Epsilon:</span><span id="ai-epsilon">--</span></div>
                <div class="stat-row"><span>Excited/Bored/Sad:</span><span id="ai-personality">--</span></div>
            </div>
        </section>
        <section id="handshakes" class="grid-container-full">
            <div class="module" style="height:100%;"><div class="module-header"><h3 class="module-title">CAPTURED HANDSHAKES</h3></div><div class="module-content scrollbar-custom"><table class="table" id="handshakes-table"><thead><tr><th>Filename</th><th>Date</th><th>Size</th><th>Action</th></tr></thead><tbody></tbody></table></div></div>
        </section>
        <section id="peers" class="grid-container-full">
            <div class="module" style="height:100%;"><div class="module-header"><h3 class="module-title">VISIBLE PEERS</h3></div><div class="module-content scrollbar-custom" id="peer-list"></div></div>
        </section>
        <section id="plugins" class="grid-container-full">
            <div class="module" style="height:100%;"><div class="module-header"><h3 class="module-title">PLUGIN MANAGEMENT</h3></div><div class="module-content scrollbar-custom" id="plugin-list-container"></div></div>
        </section>
        <section id="config" class="grid-container-full">
            <div class="module" style="height:100%;"><div class="module-header"><h3 class="module-title">CONFIGURATION (config.toml)</h3></div><div class="module-content"><textarea id="config-editor" spellcheck="false"></textarea><div style="text-align:right;margin-top:1rem;"><button class="button warning" onclick="saveConfig()">SAVE & RESTART</button></div></div></div>
        </section>
    </main>
    <footer>
        <div id="footer-status">Connecting...</div>
        <div class="footer-controls">
            <button class="button warning" id="ai-toggle-btn" onclick="toggleAI()">TOGGLE AI</button>
            <button class="button" onclick="restartPwnagotchi()">RESTART SERVICE</button>
            <button class="button danger" onclick="shutdownSystem()">SHUTDOWN SYSTEM</button>
        </div>
    </footer>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // DOM Cache
    const DOM = {
        moodFace: document.getElementById('mood-face'), moodText: document.getElementById('mood-text'),
        cpuUsage: document.getElementById('cpu-usage'), memoryUsage: document.getElementById('memory-usage'),
        temperature: document.getElementById('temperature'), uptime: document.getElementById('uptime'),
        epoch: document.getElementById('epoch'), networksCount: document.getElementById('networks-count'),
        handshakeCount: document.getElementById('handshake-count'), peerCount: document.getElementById('peer-count'),
        aiMode: document.getElementById('ai-mode'), aiLr: document.getElementById('ai-lr'),
        aiEpsilon: document.getElementById('ai-epsilon'), aiPersonality: document.getElementById('ai-personality'),
        footerStatus: document.getElementById('footer-status'), handshakesTableBody: document.querySelector('#handshakes-table tbody'),
        peerList: document.getElementById('peer-list'), pluginListContainer: document.getElementById('plugin-list-container'),
        configEditor: document.getElementById('config-editor'), navLinks: document.querySelectorAll('nav .nav-link'),
        sections: document.querySelectorAll('main section')
    };

    // Navigation
    const switchTab = (targetId) => {
        DOM.navLinks.forEach(l => l.classList.toggle('active', l.hash === targetId));
        DOM.sections.forEach(s => s.classList.toggle('active', `#${s.id}` === targetId));
        if (targetId === '#plugins') loadPlugins();
        if (targetId === '#config') loadConfig();
    };
    DOM.navLinks.forEach(link => link.addEventListener('click', (e) => { e.preventDefault(); switchTab(link.hash); }));

    // Data Renderers
    const updateDashboard = (data) => {
        const dev = data.device_info || {};
        const sess = data.session_stats || {};
        const ai = data.ai_stats || {};

        DOM.moodFace.textContent = dev.face || '(‚äô_‚äô)';
        DOM.moodText.textContent = dev.status || '...';
        DOM.cpuUsage.textContent = `${dev.cpu_load || 0}%`;
        DOM.memoryUsage.textContent = `${dev.memory || '0/0'}`;
        DOM.temperature.textContent = `${dev.temperature || 0}¬∞C`;
        DOM.uptime.textContent = dev.uptime || '--';
        DOM.epoch.textContent = dev.epoch || 0;
        DOM.networksCount.textContent = sess.aps_total || 0;
        DOM.handshakeCount.textContent = sess.handshakes_total || 0;
        DOM.peerCount.textContent = (data.peers || []).length;
        
        DOM.aiMode.textContent = ai.ai_enabled ? 'AUTO' : 'MANU';
        DOM.aiLr.textContent = ai.learning_rate;
        DOM.aiEpsilon.textContent = ai.epsilon;
        DOM.aiPersonality.textContent = `${ai.excited_epochs}/${ai.bored_epochs}/${ai.sad_epochs}`;
        
        DOM.footerStatus.textContent = `Pwnagotchi is ${dev.status || 'learning'}... | Last Update: ${new Date(data.timestamp).toLocaleTimeString()}`;
    };

    const renderHandshakes = (handshakes) => {
        if (!handshakes) return;
        DOM.handshakesTableBody.innerHTML = '';
        handshakes.forEach(handshake => {
            const row = document.createElement('tr');
            const date = new Date(handshake.timestamp * 1000);
            row.innerHTML = `
                <td>${handshake.name}</td>
                <td>${date.toLocaleString()}</td>
                <td>${handshake.size_kb} KB</td>
                <td><a href="/api/handshakes/${handshake.name}" class="button">Download</a></td>
            `;
            DOM.handshakesTableBody.appendChild(row);
        });
    };
    const renderPeers = (peers) => {
        if (!peers) return;
        DOM.peerList.innerHTML = '';
        peers.forEach(peer => {
            const peerDiv = document.createElement('div');
            peerDiv.className = 'stat-row';
            peerDiv.innerHTML = `<span>${peer.advertisement.name}</span><span>${peer.advertisement.face}</span>`;
            DOM.peerList.appendChild(peerDiv);
        });
    };
    const loadPlugins = async () => {
        try {
            const response = await fetch('/api/plugins');
            const plugins = await response.json();
            renderPlugins(plugins);
        } catch (e) {
            console.error("Failed to load plugins:", e);
        }
    };

    const renderPlugins = (plugins) => {
        if (!plugins) return;
        DOM.pluginListContainer.innerHTML = '';
        plugins.forEach(plugin => {
            const pluginDiv = document.createElement('div');
            pluginDiv.className = 'stat-row';
            pluginDiv.innerHTML = `
                <span>${plugin.name}</span>
                <div class="toggle-switch ${plugin.enabled ? 'active' : ''}" onclick="togglePlugin('${plugin.name}')"></div>
            `;
            DOM.pluginListContainer.appendChild(pluginDiv);
        });
    };
    const loadConfig = async () => {
        try {
            const response = await fetch('/api/config');
            const config = await response.text();
            DOM.configEditor.value = config;
        } catch (e) {
            console.error("Failed to load config:", e);
        }
    };
    
    // WebSocket
    const connectWebSocket = () => {
        const ws = new WebSocket(`${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}/ws`);
        ws.onopen = () => { DOM.footerStatus.textContent = "Live connection established."; };
        ws.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                if (data.error) { DOM.footerStatus.textContent = `Error: ${data.error}`; return; }
                updateDashboard(data); renderHandshakes(data.handshakes); renderPeers(data.peers);
            } catch (e) { console.error("Failed to parse WebSocket message:", e); }
        };
        ws.onclose = () => { DOM.footerStatus.textContent = "Connection lost. Retrying..."; setTimeout(connectWebSocket, 3000); };
        ws.onerror = (error) => { console.error("WebSocket error:", error); ws.close(); };
    };

    connectWebSocket();
});

// Control Functions (made global for onclick handlers)
async function sendControlCommand(endpoint, confirmMsg) {
    if (!confirm(confirmMsg)) return;
    try {
        const response = await fetch(endpoint, { method: 'POST' });
        const result = await response.json();
        alert(result.message || result.error || "An unknown error occurred.");
        return response.ok;
    } catch (e) {
        alert("Failed to send command to the backend.");
        return false;
    }
}
function toggleAI() { sendControlCommand('/api/control/toggle_ai', 'This will restart Pwnagotchi. Are you sure you want to toggle the AI mode?'); }
function restartPwnagotchi() { sendControlCommand('/api/control/restart', 'Are you sure you want to restart the Pwnagotchi service?'); }
function shutdownSystem() { sendControlCommand('/api/control/shutdown', 'WARNING: This will shut down the entire device. Are you sure?'); }
async function togglePlugin(name) { if (await sendControlCommand(`/api/plugins/toggle/${name}`, `This will restart Pwnagotchi. Toggle the '${name}' plugin?`)) { setTimeout(() => document.querySelector('a[href="#plugins"]').click(), 2000); } }
async function saveConfig() {
    if (!confirm("This will overwrite your config.toml and restart Pwnagotchi. Are you sure?")) return;
    const configContent = document.getElementById('config-editor').value;
    try {
        const response = await fetch('/api/config', { method: 'POST', headers: { 'Content-Type': 'text/plain' }, body: configContent });
        const result = await response.json();
        alert(result.message || result.error);
    } catch (e) { alert("Failed to save configuration."); }
}
</script>
</body>
</html>